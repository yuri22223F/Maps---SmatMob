<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Pontos de Fuga com Rotas</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #f4f4f5; /* zinc-100 */
        }

        #map {
            height: 100vh;
            width: 100vw;
            z-index: 1;
        }
        
        .leaflet-routing-container {
            display: none;
        }

        .map-emoji-icon {
            font-size: 28px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #333;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: var(--shadow);
            color: #18181b; /* zinc-900 */
        }
        
        .panel-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .routing-panel {
            padding: 15px;
            width: 280px;
        }
        
        .panel-title {
            margin-top: 0;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0, 0.1);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .routing-panel input[type="text"], .panel-select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: #f4f4f5;
            border: 1px solid #d4d4d8;
            box-sizing: border-box;
            font-size: 0.9em;
            color: #18181b;
        }
        .routing-panel input[type="text"]::placeholder { color: #71717a; }
        
        .panel-select option {
            background-color: white;
        }
        
        .panel-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .panel-button:hover { background: #4338ca; }
        
        #clear-route-btn {
            background-color: #ef4444; /* red-500 */
        }
        #clear-route-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        
        .loader {
            border: 4px solid #e4e4e7;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .nearby-panel {
            padding: 15px;
            width: 280px;
        }

        .nearby-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px; 
            overflow-y: auto;
            font-size: 0.9em;
        }
        .nearby-list::-webkit-scrollbar { width: 5px; }
        .nearby-list::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 5px; }


        .nearby-list li {
            padding: 10px;
            border-bottom: 1px solid #e4e4e7;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .nearby-list li:last-child { border-bottom: none; }
        .nearby-list li:hover { background-color: #f4f4f5; }
        
        .nearby-list .distance {
            display: block;
            font-size: 0.8em;
            color: #71717a;
            margin-top: 4px;
        }

        .trip-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e4e4e7;
            font-size: 0.9em;
            color: #3f3f46;
            line-height: 1.6;
        }
        .trip-summary strong {
            color: #18181b;
        }

        .back-button {
            position: absolute; top: 20px; right: 20px; z-index: 1001; padding: 10px 15px;
            font-weight: bold; text-decoration: none; transition: all 0.2s ease;
        }
        .back-button:hover { transform: scale(1.05); }

        .leaflet-control-layers {
            border-radius: 8px !important;
        }

        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:1002;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}.modal-overlay.visible{opacity:1;visibility:visible}.modal-container{width:90%;max-width:450px;max-height:85vh;overflow-y:auto;padding:25px;transform:scale(.9);transition:transform .3s}.modal-overlay.visible .modal-container{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:10px;margin-bottom:15px}.modal-header h2{margin:0;font-size:1.5em;font-weight:700; color: #111;}.modal-header .emoji-title{font-size:2em;margin-right:10px}.close-button{background:none;border:none;font-size:2em;cursor:pointer;color:#999;line-height:1;transition:color .2s}.close-button:hover{color:#333}.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;font-weight:700;color:#333}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:6px;background-color:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.2);box-sizing:border-box;font-size:1em;color:#333}.form-group input::placeholder,.form-group textarea::placeholder{color:#777}.form-button{width:100%;padding:12px;background:var(--primary-color);color:#fff;border:none;border-radius:8px;font-size:1.1em;font-weight:700;cursor:pointer;transition:background-color .2s}.form-button:hover{background:#4338ca}.rating-stars{display:inline-flex;flex-direction:row-reverse;justify-content:flex-end}.rating-stars input{display:none}.rating-stars label{font-size:2em;color:#ddd;cursor:pointer;transition:color .2s}.rating-stars input:checked~label,.rating-stars label:hover,.rating-stars label:hover~label{color:#facc15}h3{margin-top:20px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:5px;font-weight:700; color: #111;}.comments-list{list-style:none;padding:0}.comment-item{background:rgba(0,0,0,0.04);padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid var(--primary-color)}.comment-item p{margin:0;color:#555}.comment-item .stars{color:#facc15;margin-bottom:5px}.average-rating{font-size:1.1em;font-weight:700;color:#333}.average-rating .stars{color:#facc15}
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="notification-container"></div>
    
    <a href="SEU_LINK_COMPLETO_DO_GITHUB_PAGES" class="back-button glass-panel">‚Üê Voltar</a>

    <div class="panel-container">
        <div class="routing-panel glass-panel">
            <h3 class="panel-title">Calcular Rota</h3>
            <div class="control-group">
                <input type="text" id="start-location-input" placeholder="In√≠cio (ex: Av. Paulista, 1000)">
                <input type="text" id="end-location-input" placeholder="Destino (ex: Pra√ßa da S√©)">
            </div>
            <div class="control-group">
                <button id="calculate-route-btn" class="panel-button">Calcular Rota</button>
            </div>
            <div class="control-group">
                <button id="clear-route-btn" class="panel-button">Limpar Rota</button>
            </div>
            <div id="trip-summary" class="trip-summary">
                <!-- A descri√ß√£o da viagem aparecer√° aqui -->
            </div>
        </div>

        <div class="nearby-panel glass-panel">
            <h3 class="panel-title">Pontos Pr√≥ximos</h3>
            <div class="control-group">
                <label for="nearby-filter" style="display:block; margin-bottom: 8px; font-weight: bold;">Filtrar por Categoria</label>
                <select id="nearby-filter" class="panel-select">
                    <option value="all">Todas as Categorias</option>
                    <option value="gas">Posto de gasolina ‚õΩ</option>
                    <option value="hotel">Hotel üè®</option>
                    <option value="water">√Ågua üíß</option>
                    <option value="food">Restaurante üç¥</option>
                    <option value="mechanic">Oficina Mec√¢nica üõ†Ô∏è</option>
                    <option value="parking">Estacionamento üÖøÔ∏è</option>
                    <option value="tire_repair">Borracharia ‚öôÔ∏è</option>
                </select>
            </div>
            <div class="control-group">
                <button id="find-nearby-btn" class="panel-button">
                    <span id="nearby-btn-text">Encontrar Perto de Mim</span>
                    <div id="nearby-btn-loader" class="loader" style="display: none;"></div>
                </button>
            </div>
            <ul id="nearby-list" class="nearby-list">
                <!-- Resultados ser√£o inseridos aqui -->
            </ul>
        </div>
    </div>


    <div class="modal-overlay" id="modal">
        <div class="modal-container glass-panel">
            <div class="modal-header">
                <div style="display: flex; align-items: center;">
                    <span id="modal-emoji" class="emoji-title"></span>
                    <h2 id="modal-title">Detalhes do Ponto</h2>
                </div>
                <button class="close-button" id="close-modal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="point-details">
                    <div id="average-rating-container" class="average-rating"></div>
                    <h3>Coment√°rios</h3>
                    <ul id="comments-list" class="comments-list"></ul>
                </div>
                <div id="review-section">
                    <h3>Adicionar sua avalia√ß√£o</h3>
                    <form id="review-form">
                        <input type="hidden" id="point-id">
                        <div class="form-group">
                            <label>Sua Nota</label>
                            <div class="rating-stars">
                                <input type="radio" id="star5" name="rating" value="5" required/><label for="star5">‚òÖ</label>
                                <input type="radio" id="star4" name="rating" value="4"/><label for="star4">‚òÖ</label>
                                <input type="radio" id="star3" name="rating" value="3"/><label for="star3">‚òÖ</label>
                                <input type="radio" id="star2" name="rating" value="2"/><label for="star2">‚òÖ</label>
                                <input type="radio" id="star1" name="rating" value="1"/><label for="star1">‚òÖ</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="comment-text">Seu Coment√°rio</label>
                            <textarea id="comment-text" rows="3" placeholder="Ex: Banheiros limpos, bom atendimento..."></textarea>
                        </div>
                        <button type="submit" class="form-button">Enviar Avalia√ß√£o</button>
                    </form>
                </div>
                <div id="new-point-form-section">
                    <form id="new-point-form">
                        <input type="hidden" id="new-point-lat">
                        <input type="hidden" id="new-point-lng">
                        <div class="form-group">
                            <label for="new-point-name">Nome do Ponto</label>
                            <input type="text" id="new-point-name" placeholder="Ex: Posto Shell Km 12" required>
                        </div>
                        <div class="form-group">
                            <label for="new-point-type">Tipo de Ponto</label>
                            <select id="new-point-type" required>
                                <option value="gas">Posto de gasolina ‚õΩ</option>
                                <option value="hotel">Hotel üè®</option>
                                <option value="water">√Ågua üíß</option>
                                <option value="food">Restaurante üç¥</option>
                                <option value="mechanic">Oficina Mec√¢nica üõ†Ô∏è</option>
                                <option value="parking">Estacionamento üÖøÔ∏è</option>
                                <option value="tire_repair">Borracharia ‚öôÔ∏è</option>
                            </select>
                        </div>
                        <button type="submit" class="form-button">Adicionar Ponto</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONFIGURA√á√ÉO DO MAPA ---
            const tileLayerDefault = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const mapa = L.map('map', { center: [-23.5505, -46.6333], zoom: 12, layers: [tileLayerDefault] });
            
            let startPoint = null, endPoint = null;
            let routingControl = null;
            let lastNearbyPoints = [];
            let userLocationMarker = null;

            const startLocationInput = document.getElementById('start-location-input');
            const endLocationInput = document.getElementById('end-location-input');
            const calculateRouteBtn = document.getElementById('calculate-route-btn');
            const clearRouteBtn = document.getElementById('clear-route-btn');
            const tripSummaryDiv = document.getElementById('trip-summary');
            const findNearbyBtn = document.getElementById('find-nearby-btn');
            const nearbyBtnText = document.getElementById('nearby-btn-text');
            const nearbyBtnLoader = document.getElementById('nearby-btn-loader');
            const nearbyList = document.getElementById('nearby-list');
            const nearbyFilter = document.getElementById('nearby-filter');

            // --- L√ìGICA DOS PONTOS DE FUGA ---
            const EMOJIS = {
                gas: '‚õΩ', hotel: 'üè®', water: 'üíß', food: 'üç¥',
                mechanic: 'üõ†Ô∏è', parking: 'üÖøÔ∏è', tire_repair: '‚öôÔ∏è'
            };

            const defaultPontosDeFuga = [
                // (Lista completa de pontos de fuga)
                 // Centro
                 { id: 1, lat: -23.5613, lng: -46.6565, type: 'food', name: 'Restaurante na Paulista', ratings: [{stars: 5, comment: "Comida excelente!"}, {stars: 4, comment: "Bom, mas um pouco caro."}] },
                { id: 2, lat: -23.5505, lng: -46.6333, type: 'gas', name: 'Posto Central (S√©)', ratings: [{stars: 3, comment: "Pre√ßo na m√©dia."}] },
                { id: 3, lat: -23.5475, lng: -46.6361, type: 'hotel', name: 'Hotel Conforto (Rep√∫blica)', ratings: [] },
                { id: 4, lat: -23.5550, lng: -46.6400, type: 'water', name: 'Bica d\'√°gua (Bela Vista)', ratings: [{stars: 5, comment: "√Ågua fresca e pot√°vel."}]},
                { id: 13, lat: -23.5525, lng: -46.6665, type: 'mechanic', name: 'Auto El√©trico Pacaembu', ratings: [{stars: 4, comment: "Resolveu meu problema na hora."}]},
                // Zona Sul
                { id: 5, lat: -23.6215, lng: -46.7002, type: 'parking', name: 'Estacionamento Morumbi Shopping', ratings: [{stars: 4, comment: "Seguro, mas caro."}]},
                { id: 9, lat: -23.5882, lng: -46.6580, type: 'water', name: 'Bebedouro Parque Ibirapuera', ratings: [{stars: 4, comment: "Fila nos fins de semana."}]},
                { id: 10, lat: -23.6265, lng: -46.6565, type: 'hotel', name: 'Ibis Congonhas', ratings: [{stars: 4, comment: "Pr√°tico para quem vai viajar."}]},
                { id: 14, lat: -23.6499, lng: -46.6710, type: 'gas', name: 'Posto Shell - Av. Washington Lu√≠s', ratings: [{stars: 3, comment: "Pre√ßo elevado."}]},
                { id: 15, lat: -23.5689, lng: -46.6890, type: 'hotel', name: 'George V - Itaim Bibi', ratings: [{stars: 5, comment: "Luxuoso e confort√°vel."}]},
                { id: 16, lat: -23.6823, lng: -46.6955, type: 'food', name: 'Churrascaria em Interlagos', ratings: []},
                { id: 17, lat: -23.6520, lng: -46.7290, type: 'tire_repair', name: 'Borracharia Santo Amaro', ratings: [{stars: 5, comment: "R√°pido e barato."}]},
                // Zona Leste
                { id: 7, lat: -23.5410, lng: -46.5770, type: 'mechanic', name: 'Oficina Tatuap√© Reparos', ratings: [{stars: 5, comment: "Servi√ßo r√°pido e honesto."}]},
                { id: 11, lat: -23.5590, lng: -46.6080, type: 'food', name: 'Pizzaria na Mooca', ratings: [{stars: 5, comment: "Pizza tradicional e deliciosa."}]},
                { id: 18, lat: -23.5450, lng: -46.5330, type: 'parking', name: 'Estacionamento Shopping Aricanduva', ratings: [{stars: 4, comment: "Muitas vagas."}]},
                { id: 19, lat: -23.5320, lng: -46.4630, type: 'gas', name: 'Posto em Itaquera', ratings: []},
                { id: 20, lat: -23.5600, lng: -46.5650, type: 'hotel', name: 'Hotel em An√°lia Franco', ratings: [{stars: 4, comment: "Perto do shopping."}]},
                { id: 21, lat: -23.5850, lng: -46.5350, type: 'tire_repair', name: 'Borracheiro Vila Matilde', ratings: []},
                // Zona Oeste
                { id: 8, lat: -23.5655, lng: -46.6950, type: 'food', name: 'Bar do Juarez - Pinheiros', ratings: [{stars: 5, comment: "Picanha excelente."}]},
                { id: 22, lat: -23.5360, lng: -46.7450, type: 'parking', name: 'Estacionamento Parque Villa-Lobos', ratings: [{stars: 4, comment: "Bom para passear."}]},
                { id: 23, lat: -23.5540, lng: -46.7270, type: 'gas', name: 'Posto BR Butant√£', ratings: [{stars: 3, comment: "Movimentado."}]},
                { id: 24, lat: -23.5220, lng: -46.7350, type: 'mechanic', name: 'Mec√¢nica na Lapa', ratings: [{stars: 5, comment: "Confian√ßa total."}]},
                { id: 25, lat: -23.5780, lng: -46.7120, type: 'hotel', name: 'Hotel em Pinheiros', ratings: []},
                { id: 26, lat: -23.5580, lng: -46.7580, type: 'food', name: 'Restaurante na Vila Jaguara', ratings: []},
                // Zona Norte
                { id: 6, lat: -23.5008, lng: -46.6255, type: 'gas', name: 'Posto Ipiranga Santana', ratings: [{stars: 4, comment: "Bom atendimento."}]},
                { id: 12, lat: -23.5180, lng: -46.6210, type: 'parking', name: 'Estacionamento Center Norte', ratings: [{stars: 3, comment: "Sempre lotado."}]},
                { id: 27, lat: -23.4860, lng: -46.6450, type: 'food', name: 'Restaurante no Tucuruvi', ratings: [{stars: 4, comment: "Comida caseira."}]},
                { id: 28, lat: -23.4600, lng: -46.6300, type: 'mechanic', name: 'Oficina no Ja√ßan√£', ratings: []},
                { id: 29, lat: -23.4990, lng: -46.6980, type: 'hotel', name: 'Hotel na Freguesia do √ì', ratings: []},
                { id: 30, lat: -23.4750, lng: -46.7080, type: 'tire_repair', name: 'Borracharia em Pirituba', ratings: [{stars: 4, comment: "Me salvou na emerg√™ncia."}]}
            ];
            
            let pontosDeFuga = JSON.parse(localStorage.getItem('pontosDeFuga')) || defaultPontosDeFuga;
            
            let markersLayer = L.layerGroup().addTo(mapa);
            const modal = document.getElementById('modal');
            const closeModalBtn = document.getElementById('close-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalEmoji = document.getElementById('modal-emoji');
            const pointDetailsSection = document.getElementById('point-details');
            const reviewSection = document.getElementById('review-section');
            const newPointFormSection = document.getElementById('new-point-form-section');
            const reviewForm = document.getElementById('review-form');
            const newPointForm = document.getElementById('new-point-form');

            const saveData = () => localStorage.setItem('pontosDeFuga', JSON.stringify(pontosDeFuga));
            
            const renderMarkers = () => {
                markersLayer.clearLayers();
                pontosDeFuga.forEach(ponto => {
                    const customIcon = L.divIcon({ className:'map-emoji-icon', html: EMOJIS[ponto.type] || 'üìç', iconSize:[40, 40], iconAnchor:[20, 20] });
                    const marker = L.marker([ponto.lat, ponto.lng], { icon: customIcon }).addTo(markersLayer);
                    marker.on('click', () => showPointDetails(ponto.id));
                });
            };

            const calculateAverageRating=ratings=>{if(!ratings||ratings.length===0)return{avg:0,count:0};const total=ratings.reduce((acc,r)=>acc+r.stars,0);const avg=total/ratings.length;return{avg:avg.toFixed(1),count:ratings.length}};const getStarsHTML=(rating)=>{let html='';const fullStars=Math.floor(rating);const halfStar=rating%1!==0;for(let i=0;i<fullStars;i++)html+='‚òÖ';if(halfStar)html+='¬Ω';const emptyStars=5-Math.ceil(rating);for(let i=0;i<emptyStars;i++)html+='‚òÜ';return`<span class="stars" style="color: #facc15;">${html}</span>`};
            
            const showPointDetails = pointId => {
                const ponto = pontosDeFuga.find(p => p.id === pointId);
                if (!ponto) return;
                modalTitle.textContent = ponto.name;
                modalEmoji.textContent = EMOJIS[ponto.type];
                document.getElementById('point-id').value = pointId;
                const ratingInfo = calculateAverageRating(ponto.ratings);
                const avgContainer = document.getElementById('average-rating-container');
                avgContainer.innerHTML = ratingInfo.count > 0 ? `${getStarsHTML(ratingInfo.avg)} ${ratingInfo.avg} de 5 (${ratingInfo.count} avalia√ß√µes)` : 'Este ponto ainda n√£o foi avaliado.';
                
                const commentsList = document.getElementById('comments-list');
                commentsList.innerHTML = '';
                if (ponto.ratings && ponto.ratings.length > 0) {
                    ponto.ratings.forEach(rating => {
                        if (rating.comment && rating.comment.trim() !== '') {
                            const li = document.createElement('li');
                            li.className = 'comment-item';
                            li.innerHTML = `<div class="stars">${getStarsHTML(rating.stars)}</div><p>${rating.comment}</p>`;
                            commentsList.appendChild(li);
                        }
                    });
                }
                if (commentsList.children.length === 0) {
                    commentsList.innerHTML = '<li>Nenhum coment√°rio ainda. Seja o primeiro!</li>';
                }

                pointDetailsSection.style.display = 'block';
                reviewSection.style.display = 'block';
                newPointFormSection.style.display = 'none';
                modal.classList.add('visible');
            };

            const showNewPointForm = latlng => {
                modalTitle.textContent = 'Adicionar Novo Ponto';
                modalEmoji.textContent = 'üìç';
                document.getElementById('new-point-lat').value = latlng.lat;
                document.getElementById('new-point-lng').value = latlng.lng;
                pointDetailsSection.style.display = 'none';
                reviewSection.style.display = 'none';
                newPointFormSection.style.display = 'block';
                newPointForm.reset();
                modal.classList.add('visible');
            };

            const closeModal = () => {
                modal.classList.remove('visible');
                reviewForm.reset();
                newPointForm.reset();
            };

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

            reviewForm.addEventListener('submit', e => {
                e.preventDefault();
                const pointId = parseInt(document.getElementById('point-id').value);
                const ratingValue = reviewForm.querySelector('input[name="rating"]:checked');
                const commentText = document.getElementById('comment-text').value;
                if (!ratingValue) { alert('Por favor, selecione uma nota de 1 a 5 estrelas.'); return; }
                const ponto = pontosDeFuga.find(p => p.id === pointId);
                if (ponto) {
                    ponto.ratings.push({ stars: parseInt(ratingValue.value), comment: commentText.trim() });
                    saveData();
                    showPointDetails(pointId);
                    reviewForm.reset();
                }
            });

            newPointForm.addEventListener('submit', e => {
                e.preventDefault();
                const newPoint = {
                    id: Date.now(),
                    lat: parseFloat(document.getElementById('new-point-lat').value),
                    lng: parseFloat(document.getElementById('new-point-lng').value),
                    name: document.getElementById('new-point-name').value,
                    type: document.getElementById('new-point-type').value,
                    ratings: []
                };
                pontosDeFuga.push(newPoint);
                saveData();
                renderMarkers();
                closeModal();
            });

            mapa.on('click', (e) => showNewPointForm(e.latlng));
            
            // --- L√ìGICA DE ROTA (Nominatim) ---
            const geocodeAddress = async (address) => {
                try {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ", S√£o Paulo, Brasil")}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Falha na rede ao buscar endere√ßo.");
                    const data = await response.json();
                    if (data.length === 0) throw new Error(`N√£o foi poss√≠vel encontrar o endere√ßo: "${address}"`);
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                } catch (error) {
                    console.error("Erro no Nominatim:", error);
                    alert(error.message);
                    return null;
                }
            };

            const getCurrentLocation = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error("Geolocaliza√ß√£o n√£o √© suportada neste navegador."));
                    } else {
                        navigator.geolocation.getCurrentPosition(
                            (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                            () => reject(new Error("N√£o foi poss√≠vel obter a sua localiza√ß√£o."))
                        );
                    }
                });
            };

            const getCoordinatesForLocation = async (locationText) => {
                const isCurrentLocation = locationText.toLowerCase().includes('minha localiza√ß√£o') || locationText.toLowerCase().includes('localiza√ß√£o atual');
                if (isCurrentLocation) {
                    return await getCurrentLocation();
                } else {
                    return await geocodeAddress(locationText);
                }
            };

            const calculateRoute = () => {
                tripSummaryDiv.innerHTML = '';
                if (routingControl) mapa.removeControl(routingControl);

                if (startPoint && endPoint) {
                    routingControl = L.Routing.control({
                        waypoints: [startPoint, endPoint],
                        routeWhileDragging: false,
                        addWaypoints: false,
                        lineOptions: { styles: [{ color: "#4f46e5", opacity: 0.8, weight: 6 }] }
                    });

                    routingControl.on('routesfound', function(e) {
                        const summary = e.routes[0].summary;
                        const distance = (summary.totalDistance / 1000).toFixed(2);
                        const totalSeconds = summary.totalTime;
                        const hours = Math.floor(totalSeconds / 3600);
                        const minutes = Math.round((totalSeconds % 3600) / 60);
                        let timeString = '';
                        if (hours > 0) timeString += `${hours}h `;
                        timeString += `${minutes}min`;
                        tripSummaryDiv.innerHTML = `<strong>Dist√¢ncia:</strong> ${distance} km<br><strong>Tempo estimado:</strong> ${timeString}`;
                    }).addTo(mapa);

                    mapa.fitBounds(L.latLngBounds(startPoint, endPoint), { padding: [50, 50] });
                }
            };

            const calculateRouteWithNominatim = async () => {
                const startText = startLocationInput.value.trim();
                const endText = endLocationInput.value.trim();
                if (!startText || !endText) { alert("Por favor, preencha o in√≠cio e o destino."); return; }

                try {
                    const startCoords = await getCoordinatesForLocation(startText);
                    if (!startCoords) return;

                    const endCoords = await getCoordinatesForLocation(endText);
                    if (!endCoords) return;

                    startPoint = L.latLng(startCoords.lat, startCoords.lng);
                    endPoint = L.latLng(endCoords.lat, endCoords.lng);
                    calculateRoute();
                } catch (error) {
                    alert(error.message);
                }
            };

            calculateRouteBtn.addEventListener('click', calculateRouteWithNominatim);
            clearRouteBtn.addEventListener('click', () => { 
                if (routingControl) { mapa.removeControl(routingControl); routingControl = null; } 
                startPoint = null; endPoint = null; 
                startLocationInput.value = '';
                endLocationInput.value = '';
                tripSummaryDiv.innerHTML = '';
            });

             // --- L√ìGICA DE PONTOS PR√ìXIMOS COM FILTRO ---
            const toggleNearbyLoading = (isLoading) => {
                const btn = document.getElementById('find-nearby-btn');
                const text = document.getElementById('nearby-btn-text');
                const loader = document.getElementById('nearby-btn-loader');
                if (text && loader) {
                    text.style.display = isLoading ? 'none' : 'block';
                    loader.style.display = isLoading ? 'block' : 'none';
                }
                if(btn) btn.disabled = isLoading;
            };

            const displayNearbyPoints = (points) => {
                const list = document.getElementById('nearby-list');
                list.innerHTML = '';
                if (points.length === 0) { 
                    list.innerHTML = '<li>Nenhum ponto encontrado para esta categoria.</li>';
                    return; 
                }
                points.forEach(item => {
                    const li = document.createElement('li');
                    const distanceKm = (item.distance / 1000).toFixed(2);
                    li.innerHTML = `${EMOJIS[item.ponto.type]} ${item.ponto.name}<span class="distance">${distanceKm} km de dist√¢ncia</span>`;
                    li.addEventListener('click', () => {
                        mapa.flyTo([item.ponto.lat, item.ponto.lng], 16);
                        showPointDetails(item.ponto.id);
                    });
                    list.appendChild(li);
                });
            };

            const updateNearbyListDisplay = () => {
                if (lastNearbyPoints.length === 0) return;

                const filterValue = document.getElementById('nearby-filter').value;
                let filteredPoints;

                if (filterValue === 'all') {
                    filteredPoints = lastNearbyPoints;
                } else {
                    filteredPoints = lastNearbyPoints.filter(item => item.ponto.type === filterValue);
                }

                const closestPoints = filteredPoints.slice(0, 5);
                displayNearbyPoints(closestPoints);
            };

            const findNearbyPoints = async () => {
                toggleNearbyLoading(true);
                const list = document.getElementById('nearby-list');
                list.innerHTML = '<li>Buscando sua localiza√ß√£o...</li>';
                try {
                    const coords = await getCurrentLocation();
                    const userLatLng = L.latLng(coords.lat, coords.lng);
                    if (userLocationMarker) { mapa.removeLayer(userLocationMarker); }
                    userLocationMarker = L.marker(userLatLng).addTo(mapa).bindPopup('Voc√™ est√° aqui!').openPopup();
                    mapa.flyTo(userLatLng, 14);
                    
                    const distances = pontosDeFuga.map(ponto => {
                        const pontoLatLng = L.latLng(ponto.lat, ponto.lng);
                        return { ponto, distance: userLatLng.distanceTo(pontoLatLng) };
                    });

                    lastNearbyPoints = distances.sort((a, b) => a.distance - b.distance);
                    updateNearbyListDisplay(); // Usa a nova fun√ß√£o para filtrar e mostrar

                } catch (error) {
                    alert(error.message);
                    list.innerHTML = `<li>${error.message}</li>`;
                } finally {
                    toggleNearbyLoading(false);
                }
            };
            
            // --- EVENT LISTENERS ---
            const findNearbyBtnElem = document.getElementById('find-nearby-btn');
            if (findNearbyBtnElem) findNearbyBtnElem.addEventListener('click', findNearbyPoints);
            
            const nearbyFilterElem = document.getElementById('nearby-filter');
            if(nearbyFilterElem) nearbyFilterElem.addEventListener('change', updateNearbyListDisplay);


            // --- INICIALIZA√á√ÉO ---
            renderMarkers();
        });
    </script>
</body>
</html>

