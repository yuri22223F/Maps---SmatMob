<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Rota com Pontos de Fuga</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5;
            --route-primary-color: #3388ff;
            --route-secondary-color: #8a8a8a;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --success-color: #22c55e;
            --error-color: #ef4444;
        }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f4f4f5; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .leaflet-routing-container { display: none; }
        .map-emoji-icon { font-size: 28px; text-shadow: 0 1px 3px rgba(0,0,0,0.2); background: white; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border: 2px solid #333; }
        .panel-container { position: absolute; top: 20px; left: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 15px; max-height: calc(100vh - 40px); overflow-y: auto; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; box-shadow: var(--shadow); color: #18181b; padding: 15px; width: 300px; box-sizing: border-box; }
        .panel-title { margin-top: 0; font-size: 1.2em; font-weight: 700; text-align: center; border-bottom: 1px solid rgba(0,0,0, 0.1); padding-bottom: 10px; margin-bottom: 15px; }
        .control-group { margin-bottom: 15px; }
        .panel-container input[type="text"], .panel-select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; background-color: #f4f4f5; border: 1px solid #d4d4d8; box-sizing: border-box; font-size: 0.9em; color: #18181b; }
        .panel-container input[type="text"]::placeholder { color: #71717a; }
        .panel-select option { background-color: white; color: #18181b; }
        .panel-button { width: 100%; padding: 10px; margin-bottom: 5px; border: none; background-color: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .panel-button:hover:not(:disabled) { background: #4338ca; }
        .panel-button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        #clear-route-btn { background-color: #ef4444; }
        #clear-route-btn:hover { background-color: #dc2626; }
        .trip-summary { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e4e4e7; font-size: 0.9em; color: #3f3f46; line-height: 1.6; }
        .trip-summary strong { color: #18181b; }
        .loader { border: 4px solid #e4e4e7; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .notification { padding: 15px 20px; border-radius: 8px; color: white; opacity: 0; transform: translateY(20px); animation: fadeIn 0.5s forwards; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .notification.error { background-color: var(--error-color); } .notification.success { background-color: var(--success-color); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:1002;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
        .modal-overlay.visible{opacity:1;visibility:visible}
        .modal-container{width:90%;max-width:450px;max-height:85vh;overflow-y:auto;padding:25px;transform:scale(.9);transition:transform .3s}
        .modal-overlay.visible .modal-container{transform:scale(1)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:10px;margin-bottom:15px}
        .modal-header h2{margin:0;font-size:1.5em;font-weight:700; color: #111;}
        .modal-header .emoji-title{font-size:2em;margin-right:10px}
        .close-button{background:none;border:none;font-size:2em;cursor:pointer;color:#999;line-height:1;transition:color .2s}
        .close-button:hover{color:#333}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:5px;font-weight:700;color:#333}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:6px;background-color:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.2);box-sizing:border-box;font-size:1em;color:#333}
        .form-group input::placeholder,.form-group textarea::placeholder{color:#777}
        .form-button{width:100%;padding:12px;background:var(--primary-color);color:#fff;border:none;border-radius:8px;font-size:1.1em;font-weight:700;cursor:pointer;transition:background-color .2s}
        .form-button:hover{background:#4338ca}
        .rating-stars{display:inline-flex;flex-direction:row-reverse;justify-content:flex-end}
        .rating-stars input{display:none}
        .rating-stars label{font-size:2em;color:#ddd;cursor:pointer;transition:color .2s}
        .rating-stars input:checked~label,.rating-stars label:hover,.rating-stars label:hover~label{color:#facc15}
        h3{margin-top:20px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:5px;font-weight:700; color: #111;}
        .comments-list{list-style:none;padding:0}
        .comment-item{background:rgba(0,0,0,0.04);padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid var(--primary-color)}
        .comment-item p{margin:0;color:#555}
        .comment-item .stars{color:#facc15;margin-bottom:5px}
        .average-rating{font-size:1.1em;font-weight:700;color:#333}
        .average-rating .stars{color:#facc15}
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="notification-container"></div>

    <div class="panel-container">
        <div class="glass-panel">
            <h3 class="panel-title">Calcular Rota</h3>
            <div class="control-group">
                <input type="text" id="start-location-input" placeholder="Início (ex: Av. Paulista, 1000)">
                <input type="text" id="end-location-input" placeholder="Destino (ex: Praça da Sé)">
            </div>
            <div class="control-group">
                <button id="calculate-route-btn" class="panel-button">
                    <span id="route-btn-text">Calcular Rota</span>
                    <div id="route-loader" class="loader" style="display: none;"></div>
                </button>
            </div>
            <div class="control-group">
                <button id="clear-route-btn" class="panel-button">Limpar Rota</button>
            </div>
            <div id="trip-summary" class="trip-summary"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-container glass-panel">
            <div class="modal-header">
                <div style="display: flex; align-items: center;">
                    <span id="modal-emoji" class="emoji-title"></span>
                    <h2 id="modal-title">Detalhes do Ponto</h2>
                </div>
                <button class="close-button" id="close-modal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="point-details">
                    <div id="average-rating-container" class="average-rating"></div>
                    <h3>Comentários</h3>
                    <ul id="comments-list" class="comments-list"></ul>
                </div>
                <div id="review-section">
                    <h3>Adicionar sua avaliação</h3>
                    <form id="review-form">
                        <input type="hidden" id="point-id">
                        <div class="form-group">
                            <label>Sua Nota</label>
                            <div class="rating-stars">
                                <input type="radio" id="star5" name="rating" value="5" required/><label for="star5">★</label>
                                <input type="radio" id="star4" name="rating" value="4"/><label for="star4">★</label>
                                <input type="radio" id="star3" name="rating" value="3"/><label for="star3">★</label>
                                <input type="radio" id="star2" name="rating" value="2"/><label for="star2">★</label>
                                <input type="radio" id="star1" name="rating" value="1"/><label for="star1">★</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="comment-text">Seu Comentário</label>
                            <textarea id="comment-text" rows="3" placeholder="Ex: Banheiros limpos, bom atendimento..."></textarea>
                        </div>
                        <button type="submit" class="form-button">Enviar Avaliação</button>
                    </form>
                </div>
                <div id="new-point-form-section">
                    <form id="new-point-form">
                        <input type="hidden" id="new-point-lat">
                        <input type="hidden" id="new-point-lng">
                        <div class="form-group">
                            <label for="new-point-name">Nome do Ponto</label>
                            <input type="text" id="new-point-name" placeholder="Ex: Posto Shell Km 12" required>
                        </div>
                        <div class="form-group">
                            <label for="new-point-type">Tipo de Ponto</label>
                            <select id="new-point-type" required>
                                <option value="gas">Posto de gasolina ⛽</option>
                                <option value="hotel">Hotel 🏨</option>
                                <option value="water">Água 💧</option>
                                <option value="food">Restaurante 🍴</option>
                                <option value="mechanic">Oficina Mecânica 🛠️</option>
                                <option value="parking">Estacionamento 🅿️</option>
                                <option value="tire_repair">Borracharia ⚙️</option>
                            </select>
                        </div>
                        <button type="submit" class="form-button">Adicionar Ponto</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tileLayerDefault = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });
            const tileLayerDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap & CARTO'
            });
            const tileLayerMinimal = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap & CARTO'
            });

            const mapa = L.map('map').setView([-23.5505, -46.6333], 12);
            tileLayerDefault.addTo(mapa);
            L.control.layers({ "Padrão": tileLayerDefault, "Escuro": tileLayerDark, "Minimalista": tileLayerMinimal }).addTo(mapa);

            let startPoint = null, endPoint = null, routingControl = null;
            const startLocationInput = document.getElementById('start-location-input');
            const endLocationInput = document.getElementById('end-location-input');
            const calculateRouteBtn = document.getElementById('calculate-route-btn');
            const clearRouteBtn = document.getElementById('clear-route-btn');
            const tripSummaryDiv = document.getElementById('trip-summary');
            const routeBtnText = document.getElementById('route-btn-text');
            const routeLoader = document.getElementById('route-loader');

            const EMOJIS = { gas: '⛽', hotel: '🏨', water: '💧', food: '🍴', mechanic: '🛠️', parking: '🅿️', tire_repair: '⚙️' };
            const defaultPontosDeFuga = [
                { id: 1, lat: -23.5613, lng: -46.6565, type: 'food', name: 'Restaurante na Paulista', ratings: [{stars: 5, comment: "Comida excelente!"}, {stars: 4, comment: "Bom, mas um pouco caro."}] },
                { id: 2, lat: -23.5505, lng: -46.6333, type: 'gas', name: 'Posto Central (Sé)', ratings: [{stars: 3, comment: "Preço na média."}] },
            ];

            let pontosDeFuga = JSON.parse(localStorage.getItem('pontosDeFuga')) || defaultPontosDeFuga;
            let markersLayer = L.layerGroup().addTo(mapa);

            const modal = document.getElementById('modal');
            const closeModalBtn = document.getElementById('close-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalEmoji = document.getElementById('modal-emoji');
            const pointDetailsSection = document.getElementById('point-details');
            const reviewSection = document.getElementById('review-section');
            const newPointFormSection = document.getElementById('new-point-form-section');
            const reviewForm = document.getElementById('review-form');
            const newPointForm = document.getElementById('new-point-form');

            const saveData = () => localStorage.setItem('pontosDeFuga', JSON.stringify(pontosDeFuga));

            const renderMarkers = () => {
                markersLayer.clearLayers();
                pontosDeFuga.forEach(ponto => {
                    const customIcon = L.divIcon({ className:'map-emoji-icon', html: EMOJIS[ponto.type] || '📍', iconSize:[40, 40], iconAnchor:[20, 20] });
                    L.marker([ponto.lat, ponto.lng], { icon: customIcon }).addTo(markersLayer).on('click', () => showPointDetails(ponto.id));
                });
            };

            const getStarsHTML = r => {
                let t="", e=Math.floor(r), s=0!==r%1;
                for(let a=0;a<e;a++) t+="★";
                s&&(t+="½");
                let o=5-Math.ceil(r);
                for(let a=0;a<o;a++) t+="☆";
                return `<span class="stars" style="color: #facc15;">${t}</span>`;
            };

            const showPointDetails = pointId => {
                const ponto = pontosDeFuga.find(p => p.id === pointId);
                if (!ponto) return;
                modalTitle.textContent = ponto.name;
                modalEmoji.textContent = EMOJIS[ponto.type];
                document.getElementById('point-id').value = pointId;
                const ratings = ponto.ratings || [];
                const ratingInfo = ratings.length > 0 ? { avg: (ratings.reduce((a, r) => a + r.stars, 0) / ratings.length).toFixed(1), count: ratings.length } : { avg: 0, count: 0 };
                document.getElementById('average-rating-container').innerHTML = ratingInfo.count > 0 ? `${getStarsHTML(ratingInfo.avg)} ${ratingInfo.avg} de 5 (${ratingInfo.count} avaliações)` : 'Este ponto ainda não foi avaliado.';

                const commentsList = document.getElementById('comments-list');
                commentsList.innerHTML = '';
                if (ratings.length > 0) {
                    ratings.sort((a, b) => (b.comment && !a.comment) ? 1 : -1).forEach(r => {
                        if (r.comment && r.comment.trim() !== '') {
                            const li = document.createElement('li');
                            li.className = 'comment-item';
                            li.innerHTML = `<div class="stars">${getStarsHTML(r.stars)}</div><p>${r.comment}</p>`;
                            commentsList.appendChild(li);
                        }
                    });
                }
                if (commentsList.children.length === 0) commentsList.innerHTML = '<li>Nenhum comentário ainda. Seja o primeiro!</li>';

                pointDetailsSection.style.display = 'block';
                reviewSection.style.display = 'block';
                newPointFormSection.style.display = 'none';
                modal.classList.add('visible');
            };

            const showNewPointForm = latlng => {
                modalTitle.textContent = 'Adicionar Novo Ponto';
                modalEmoji.textContent = '📍';
                document.getElementById('new-point-lat').value = latlng.lat;
                document.getElementById('new-point-lng').value = latlng.lng;
                pointDetailsSection.style.display = 'none'; reviewSection.style.display = 'none'; newPointFormSection.style.display = 'block';
                newPointForm.reset();
                modal.classList.add('visible');
            };

            const closeModal = () => { modal.classList.remove('visible'); reviewForm.reset(); newPointForm.reset(); };
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

            reviewForm.addEventListener('submit', e => {
                e.preventDefault();
                const pointId = parseInt(document.getElementById('point-id').value);
                const ratingValue = reviewForm.querySelector('input[name="rating"]:checked');
                const commentText = document.getElementById('comment-text').value;
                if (!ratingValue) { showNotification('Por favor, selecione uma nota de 1 a 5 estrelas.', 'error'); return; }
                const ponto = pontosDeFuga.find(p => p.id === pointId);
                if (ponto) {
                    if(!ponto.ratings) ponto.ratings = [];
                    ponto.ratings.push({ stars: parseInt(ratingValue.value), comment: commentText.trim() });
                    saveData(); showPointDetails(pointId); reviewForm.reset();
                }
            });

            newPointForm.addEventListener('submit', e => {
                e.preventDefault();
                pontosDeFuga.push({
                    id: Date.now(),
                    lat: parseFloat(document.getElementById('new-point-lat').value),
                    lng: parseFloat(document.getElementById('new-point-lng').value),
                    name: document.getElementById('new-point-name').value,
                    type: document.getElementById('new-point-type').value,
                    ratings: []
                });
                saveData(); renderMarkers(); closeModal(); showNotification('Novo ponto adicionado com sucesso!', 'success');
            });

            mapa.on('click', e => { if (e.originalEvent.target.classList.contains('leaflet-container')) showNewPointForm(e.latlng); });

            const toggleRouteLoading = l => { document.getElementById('route-loader').style.display = l ? 'block' : 'none'; document.getElementById('route-btn-text').style.display = l ? 'none' : 'block'; calculateRouteBtn.disabled = l; };
            const showNotification = (m, t = 'info') => {
                const n = document.createElement('div'); n.className = `notification ${t}`; n.textContent = m;
                document.getElementById('notification-container').appendChild(n);
                setTimeout(() => { n.style.opacity = '0'; n.style.transform = 'translateY(20px)'; setTimeout(() => n.remove(), 500); }, 4000);
            };

            const getCoordinatesForLocation = async l => {
                try {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(l)}`);
                    const d = await r.json();
                    if (d && d.length > 0) return { lat: parseFloat(d[0].lat), lng: parseFloat(d[0].lon) };
                    throw new Error(`Não foi possível encontrar coordenadas para "${l}".`);
                } catch (e) { throw new Error("Erro ao buscar coordenadas. Verifique a conexão."); }
            };

            const calculateRoute = () => {
                if (routingControl) mapa.removeControl(routingControl);
                routingControl = L.Routing.control({
                    waypoints: [startPoint, endPoint],
                    routeWhileDragging: false, addWaypoints: false, show: false, showAlternatives: true,
                    lineOptions: { styles: [ { color: 'var(--route-primary-color)', opacity: 0.9, weight: 6 }, { color: 'var(--route-secondary-color)', opacity: 0.8, weight: 5, dashArray: '10, 10' } ] }
                }).addTo(mapa).on('routesfound', e => {
                    const best = e.routes[0];
                    tripSummaryDiv.innerHTML = `<strong>Distância:</strong> ${(best.summary.totalDistance / 1000).toFixed(2)} km<br><strong>Tempo estimado:</strong> ${Math.round(best.summary.totalTime / 60)} minutos`;
                });
            };

            calculateRouteBtn.addEventListener('click', async () => {
                const start = startLocationInput.value.trim(), end = endLocationInput.value.trim();
                if (!start || !end) { showNotification("Por favor, preencha o início e o destino.", 'error'); return; }
                toggleRouteLoading(true);
                try {
                    startPoint = L.latLng(await getCoordinatesForLocation(start));
                    endPoint = L.latLng(await getCoordinatesForLocation(end));
                    calculateRoute();
                } catch (e) {
                    showNotification(e.message, 'error'); console.error(e);
                } finally { toggleRouteLoading(false); }
            });

            document.getElementById('clear-route-btn').addEventListener('click', () => {
                if (routingControl) mapa.removeControl(routingControl);
                startPoint = endPoint = null;
                startLocationInput.value = ''; endLocationInput.value = '';
                tripSummaryDiv.innerHTML = '';
            });

            renderMarkers();
        });
    </script>
</body>
</html>
